---
title: Win32编程基础Chapter 3：Win API
date: 2019-04-01 13:26:20
tags:
	- Win32
	- 汇编语言
categories: Win32
---

#### 0x00 Win API概述

Win32 API实际是以一种新方法代替的DOS中用软中断的方式。

API函数即将系统的功能的封装成模块（函数），在编程中，若想要使用系统的某功能，只需要调用对应的API函数，并传入相应的参数即可。

一个个系统功能被封装成一个个API函数，最终放在Window的动态链接库（DLL）中。DLL是一种可执行文件，格式采用与.exe文件同样的PE文件格式。

在PE文件的导出表中，会以字符串的形式指出该DLL能够提供的API函数的列表，只需要在应用程序中使用字符串形式的函数名进行API函数的调用即可。

<!-- more -->

#### 0x01 Win32 API的核心由3个DLL提供：

- KERNEL32.DLL ：系统服务功能。包括内存管理、任务管理等。
- GDI32.DLL ：图像设备接口。利用显示设备驱动程序完成显示文件和矩形等功能。
- USER32.DLL ：用户接口服务。建立窗口和传递消息等。

> 此外，还有其他的DLL，不同的DLL实现不同的系统功能，如：Wsocket32.dll ：提供使用TCP/IP进行网络通信功能。 

#### 0x02 函数原型

在调用API函数时，函数原型必须预先声明，否则编译器无法识别。声明格式：

```
函数名  proto [参数1]:类型 [,参数2]:类型
```

proto是函数声明的伪指令。

参数名实际上是无意义的，因为编译器只关心参数数量，参数名在这只是提高可读性，类型基本都是dword。因此参数名可省略不写，只写 `:类型`。

#### 0x03 API函数调用：

Win32 API使用堆栈来传递参数，调用者将参数从右向左依次压入栈中，DLL中对应的被调用函数程序从栈中再依次弹出取出数据,并在返回前将栈中无用参数丢弃。

```assembly
;调用MessageBox

push uType
push lpCaption
push lpText
push hWnd
call MessageBox
```

- 在编译链接之后，`call MessageBox`语句中的MessageBox会被替换为一个指向PE导入表的地址。

传入的参数可能使用不同的数据类型，但其实对于汇编语言而言，传入的参数都是32位（dd）的整数，之所以在Win32 API中使用不同数据类型，只是为了说明用途便于理解而已。

#### 0x04 Invoke

可在每次函数调用的语句前添加，作用是检查传入的参数数量与API函数要求的参数数量是否一致，即参数是否对齐，若没有对齐，在编译程序时将报错。

该指令是伪指令，由编译器识别，并不是必要的指令。

使用格式：

```assembly
invoke 函数名 [,参数1] [,参数2] [...]
```

#### 0x05 API函数返回值

- 函数的返回值也只有dd这一种整数类型，返回值永远放在EAX寄存器中。

> 如果32位的EAX不足以存放返回数据，Win32 API采用的方法是，EAX返回一个指向真正返回值的地址指针。或者函数多定义一个参数，用于在函数调用时传递一个定义好了的缓冲区的地址，然后直接将返回值返回到缓冲区中去。

#### 0x06 include

- include作用与C语言的一样，通常用于把包含许多函数原型的文件包含进来。

> 每一个DLL对应一个<DLL库名.inc>文件，需要使用DLL中的API函数，只需要包含对应的DLL的DDL.inc文件即可。

- 编译器对于include的处理，就只是将include的文件的所有内容与该语句进行替换而已。

#### 0x07 includelib

要想使用API函数，就必须先知道API函数存在哪个DLL中，所以需要有一个文件存放DLL的正确位置信息，这个文件就是导入库。

导入库包含函数的位置信息和参数的个数等简单信息，一个DLL对应一个导入库。要想使用某DLL中的API函数，可以使用:

```assembly
includelib 库文件名
	或者
includelib <库文件名>
```

静态链接库是一组编写好的代码模块，可以在程序中被引用，程序被编译为目标文件，然后在目标文件被链接成为可执行文件的时候，链接程序会找到静态库中的相应函数代码并把它一同链接到可执行文件中。

与include不同，编译器处理includelib的方式不会把库文件的内容与该指令进行替换，它只告知连接器到指定的库文件去寻找函数的位置信息而已。

![](02-win32编程基础Chapter-3\图片1.png)