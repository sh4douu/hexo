---
title: 文件上传漏洞（File Upload）
date: 2019-03-05 13:28:41
tags:
	- 文件上传
	- 过滤与绕过
	- 靶场
categories: WEB漏洞学习
---

## 一、概述

> 文件上传漏洞是指用户上传可执行的脚本文件，并通过此脚本获得了执行服务器命令的能力。

### 0x00 漏洞常见危害

1. 上传web脚本语言文件，WEB容器解释运行了上传的脚本文件，导致代码执行。
2. 上传Flash的策略文件crossdomain.xml，黑客用以控制Flash在该域的行为。
3. 上传病毒、木马文件，并诱骗管理员或用户下载执行。
4. 上传合法文件，但内容为脚本语言代码，配合文件包含漏洞执行脚本。

<!-- more -->

### 0x01 攻击条件

1. 上传文件后，要能通过WEB访问该文件。（能知道文件的路径并能访问）
2. 上传的文件能被WEB容器解释执行。
3. 文件被安全检查、改变内容，如压缩等操作，也会导致攻击不成功。

### 0x02 安全的上传功能

1. 上传目录设置为不可执行。
2. 判断文件类型，对危险的文件类型进行过滤，且应采用白名单而不是黑名单方式过滤。
3. 使用随机数重命名上传的文件及改写路径。
4. 文件服务器使用单独的域名，这样有一些攻击会受到同源策略的影响而导致不生效。（如上传的是crossdomain.xml、XSS利用的Javascript文件等）

### 0x03 文件上传功能

> 文件上传本质上是客户端的 POST 请求，前端上传页面表单处需要指定 enctype 为 multipart/form-data 或者 Multipart/form-data 才能正常上传文件。

![](文件上传漏洞\QQ截图20190305132724.png)

## 二、文件解析漏洞

> 解析漏洞是指不同Web容器对文件的解析方式的特性，一些解析特性配合文件上传功能会造成巨大的安全问题。

### 0x00 IIS解析漏洞

**IIS 6.0解析漏洞**

1.文件名截断，截断字符为分号（;）：

- 例如文件名：`xx.asp;yy.jpg`，会被作为`xx.asp`。

2.文件夹扩展名解析漏洞，`/*.asp/`目录下的所有文件都会被作为asp文件解析。

- 例如：`/x.asp/y.jpg`，`y.jpg`会被作为asp文件解析。

3.IIS 6.0除了可以解析执行asp类型文件外，还有三种可执行文件类型：

> ```
> test.asa
> test.cer
> test.cdx
> ```

**IIS PUT漏洞**

`PUT`是在Webdav中定义的一个方法，该方法允许用户上传文件到指定路径下。

在IIS中，若目录具有`写权限`且`Webdav`是开启的，就会支持PUT方法。

![](文件上传漏洞\1544954468_5c162264b3e77.png)

![](文件上传漏洞\1544954489_5c16227975735.png)

### 0x01 Apache解析漏洞

**Apache 1.x、2.x：**

- Apache对文件名的解析是从后往前的，直到遇到可识别的文件后缀为止。
- Apache可识别的文件后缀（类型）定义在`mime.types`文件中。

> 例如文件名：`shell.php.rar.rar.rar`，Apache由于无法识别`.rar`，会从后往前一直寻找可识别的文件类型，最后会将其作为`.php`文件。

### 0x02 Nginx解析漏洞

**1.漏洞外在表现：**

- 访问：`http://xx.com/x.jpg/y.php`，`x.jpg`会被作为php文件执行。注意`y.php`是实际不存在的。

**2.漏洞原理：**

- 严格来说这并不是Nginx的漏洞，Nginx通常是以fastcgi的方式支持PHP解析的，nginx作为代理把HTTP请求转发给fastcgi Server。
- 在nginx配置文件中通过正则匹配设置`SCRIPT_FILENAME`。当访问`http://xx.com/shell.jpg/test.php`这个URL时，`$fastcgi_script_name`会被设置为`shell.jpg/test.php`，然后将构造好的`SCRIPT_FILENAME`传递给cgi Server。
- 当php开启`cgi.fix_pathinfo`这个选项时（默认开启），那么就会触发在PHP中的如下逻辑：
  - PHP会认为`SCRIPT_FILENAME`是`shell.jpg`，而`test.php`是`PATH_INFO`，所以就会将`shell.jpg`作为PHP文件来解析了。
- 因此这实际不是nginx的漏洞，在使用fastcgi的其他环境下，PHP也存在相同问题，IIS7.0/7.5就是这样的。

**3.漏洞修复：**

- 修改`php.ini`文件，将`cgi.fix_pathinfo`的值设置为0;

## 三、文件上传过滤与绕过

![](文件上传漏洞\20180712092548-81b98800-85-1.png)

结合`upload-labs`文件上传漏洞靶场进行分析学习。

靶场地址：`https://github.com/c0ny1/upload-labs`

### 0x00 前端过滤与绕过（Pass-01）

***过滤:***

前端使用JS对上传的文件后缀进行限制。

![](文件上传漏洞\QQ截图20190305144900.png)

***绕过:***

禁用浏览器Javascript。

或者使用Burpsuite抓包修改文件名的方式。

![](文件上传漏洞\QQ截图20190305145812.png)

![](文件上传漏洞\QQ截图20190305150014.png)

### 0x01 后端过滤与绕过

**1.Mime类型过滤：Content-Type （Pass-02）**

***过滤代码：***只允许上传特定mime类型的文件。

![](文件上传漏洞\QQ截图20190305150607.png)

***Mime类型过滤绕过：***

抓包修改Content-Type为允许的类型即可。实际情况中不知允许mime的类型，可以使用Burp进行枚举。

![](文件上传漏洞\QQ截图20190305151049.png)

**2.黑名单过滤之过滤不全 (Pass-03)**

***过滤代码：***

![](文件上传漏洞\QQ截图20190305151732.png)

***绕过方式：***

被过滤的后缀很少时可以尝试使用其他未加入黑名单且可以被解析的文件后缀。如：`.php3`、`.php4`、`.phtml`等后缀。

**3.黑名单过滤之未过滤.htaccess （Pass-04）**

***过滤代码：***

![](文件上传漏洞\QQ截图20190305161438.png)

***绕过方式：***

可以发现大部分文件后缀被过滤，但`.htaccess`未被过滤时，可以上传一个`.htaccess`文件，文件内容：

> `SetHandler application/x-httpd-php`

![](文件上传漏洞\QQ截图20190305154725.png)

上传这样的`.htaccess`文件后，所有文件都会被解析为php，然后再上传图片马，图片会被解析为php文件执行，就可以绕过过滤实现攻击。

DOS下图片马制作：

> **`copy /b a.png + /a b.php  c.png`**
>
> > - `/b`表示a.png是二进制文件，以二进制方式合并文件。
> > - `/a`表示b.php是ASCII文件。（该参数可以省略）
> > - `c.png`是合并后得到的文件。

上传图片马并访问：

![](文件上传漏洞\QQ截图20190305160625.png)

> PS:`.htacess`该文件仅在Apache平台上存在，IIS平台上不存在该文件，该文件默认开启，启用和关闭在httpd.conf文件中配置。`.htaccess`文件(或者”分布式配置文件”），提供了针对目录改变配置的方法， 即，在一个特定的文档目录中放置一个包含一个或多个指令的文件， 以作用于此目录及其所有子目录。

**4.黑名单过滤之未统一大小写 （Pass-05）**

***过滤代码：***`strtolower()`字符串函数会将字符串的所有字符变为小写。

![](文件上传漏洞\QQ截图20190305163146.png)

***绕过方式：***

由于未统一大小写，导致过滤不全，可尝试`.PhP`、`.pHP`等后缀的方式绕过。

**5.黑名单过滤之未去除空白 （Pass-06）**

***过滤代码：***`trim()`字符串函数会将字符串首尾的空白去除。

![](文件上传漏洞\QQ截图20190305163603.png)

***绕过方式：***

在文件后缀前或者后面加入空白。

**6.黑名单过滤之未去除"." （Pass-07）**

***过滤代码：***

![](文件上传漏洞\QQ截图20190305164357.png)

***绕过方式：***

利用windows特性，会自动去掉后缀名中最后的`.`，可在后缀名中加`.`绕过。

抓包修改文件名，在文件名最后加入`.`。

**6.黑名单过滤之未去除"::$DATA" （Pass-08）**

***过滤代码：***

![](文件上传漏洞\QQ截图20190305165249.png)

***绕过方式：***
php在window的时候如果文件名+"::$DATA"会把::$DATA之后的数据当成文件流处理,不会检测后缀名.且保持"::$DATA"之前的文件名。目的就是不检查后缀名。

即在文件名之后加`::$DATA`绕过。

**7.黑名单过滤之文件名拼接 （Pass-09）**

***过滤代码：***

![](文件上传漏洞\QQ截图20190306092934.png)

***绕过方式：***

抓包修改文件名为：`xxxx.php. .`(点 空格 点)

**8.黑名单过滤之替换后缀名 (Pass-10)**

过滤代码：`str_ireplace(find,replace,string,count)`函数替换字符串中的一些字符（不区分大小写）。

![](文件上传漏洞\QQ截图20190306093435.png)

***绕过方式：***

使用双写后缀的方式绕过，如使用`shell.pphphp`，中间的`php`字符被替换为空后，得到`shell.php`。

**9.白名单过滤之路径拼接GET (Pass-11)**

***过滤代码：***

![](文件上传漏洞\QQ截图20190306094436.png)

***绕过方式：***

使用`%00`截断，`%00`是URL编码后的空字符，即ASCII码为0的字符（空字符），十六进制表示为`0x00`，转义字符为`\0`，在C、PHP等语言中空字符表示字符串的结束。

![](文件上传漏洞\QQ截图201903061003321.png)

> - 截断条件：
>   - php版本小于5.3.4 详情关注CVE-2006-7243
>   - php的`magic_quotes_gpc`为OFF状态   //如果不修改将无法上传成功，默认为ON
> - `%00`截断参考链接：`https://www.2cto.com/article/201502/377462.html`

**10.白名单过滤之路径拼接POST （Pass-12）**

***过滤代码：***

![](文件上传漏洞\QQ截图20190306102231.png)

***绕过方式：***

同样使用`%00`截断绕过，但是与GET方式不同的是，由于GET提交的数据是在URL中的，因此服务器会对其进行URL decode。而POST提交的是不会进行URL解码的，因此需要在十六进进制中添加`0x00`。

![](文件上传漏洞\QQ截图20190306103406.png)

![](文件上传漏洞\QQ截图20190306103855.png)

**11.文件内容过滤之内容匹配 (Pass-13)**

***过滤代码：***

![](文件上传漏洞\QQ截图20190306104525.png)

***绕过方式：***

使用图片马即可，图片马制作见Pass-04。

**12.文件内容过滤之文件类型 (Pass-14、Pass-15)**

***过滤代码：***

`getimagesize (string  $filename)`返回一个具有四个单元的数组。索引0包含图像宽度的像素值，索引 1 包含图像高度的像素值。索引 2 是图像类型的标记：1 = GIF，2 = JPG，3 = PNG，4 = SWF...

`exif_imagetype()`读取一个图像的第一个字节并检查其签名。

![](文件上传漏洞\QQ截图20190306105122.png)

![](文件上传漏洞\QQ截图20190306105746.png)

***绕过方式：***

使用图片马进行绕过。

**13.文件内容过滤之二次渲染 (Pass-16)**

***过滤代码：***

`imagecreatefromjpeg`二次渲染它相当于是把原本属于图像数据的部分抓了出来，再用自己的API 或函数进行重新渲染在这个过程中非图像数据的部分直接就隔离开了。

![](文件上传漏洞\QQ截图20190306112443.png)

***绕过方式：***

绕过方法是将一个正常显示的图片，上传到服务器。寻找图片被渲染后与原始图片对比仍然相同的数据块部分，将Webshell代码插在该部分，然后上传。具体实现需要自己编写脚本程序。

二次渲染与绕过方法参考连接：`https://secgeek.net/bookfresh-vulnerability/`

**14.条件竞争 （Pass-17）**

***过滤代码：***`unlink()`函数作用是删除文件。若成功，则返回 true，失败则返回 false。

![](文件上传漏洞\QQ截图20190306114556.png)

***绕过方式：***

这里注意一个点，不管什么文件都是会被上传到服务器上的，上传到服务器之后才进行白名单检查。

因此，绕过的思路就是在文件被安全检查删除之前访问文件。

多个进程并发访问和操作同一数据且执行结果与访问的特定顺序有关，称为竞争条件。

攻击方法：上传一个php文件，使用Burpsuite进行抓包并将数据包发送到`intruder`模块，清空变量，然后选择Payload的类型为`Null payloads`，并输入重放数据包的数量，保证不断在上传文件。同时使用浏览器不断刷新访问上传的php文件，直到访问成功。

![](文件上传漏洞\QQ截图20190306130645.png)

![](文件上传漏洞\QQ截图20190306131219.png)

![](文件上传漏洞\QQ截图20190306131709.png)

**参考连接：**

https://xz.aliyun.com/t/2435

https://github.com/LandGrey/upload-labs-writeup

http://www.cnblogs.com/shellr00t/p/6426856.html

https://www.anquanke.com/post/id/164561